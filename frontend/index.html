<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bloggin — Modern Blogging Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Quill Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      --primary: #d97706;
      --primary-dark: #b45309;
      --primary-light: #fbbf24;
      --secondary: #78716c;
      --success: #059669;
      --danger: #dc2626;
      --light-bg: #fafaf9;
      --border: #e7e5e4;
      --text-primary: #1c1917;
      --text-secondary: #57534e;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.04);
      --shadow-md: 0 2px 8px -1px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 6px 16px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 12px 24px -6px rgba(0, 0, 0, 0.12);
      --neutral-50: #fafaf9;
      --neutral-100: #f5f5f4;
      --neutral-200: #e7e5e4;
      --neutral-700: #44403c;
      --neutral-800: #292524;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      background: #ffffff;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Navigation */
    .navbar {
      background: rgba(255, 255, 255, 0.98) !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      padding: 1rem 0;
      border-bottom: 1px solid rgba(120, 113, 108, 0.1);
      backdrop-filter: blur(10px);
    }

    .navbar-brand {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary) !important;
      letter-spacing: -0.5px;
    }

    .nav-link {
      color: var(--text-secondary) !important;
      font-weight: 500;
      margin: 0 0.5rem;
      transition: color 0.2s ease;
    }

    .nav-link:hover {
      color: var(--primary) !important;
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      padding: 0.625rem 1.75rem;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      letter-spacing: -0.01em;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Hero Section */
    .hero-section {
      background: linear-gradient(135deg, #292524 0%, #44403c 100%);
      padding: 5rem 0 3rem 0;
      margin-bottom: 2.5rem;
      color: white;
      position: relative;
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="1.5" fill="%23ffffff" opacity="0.03"/></svg>');
      pointer-events: none;
    }

    .hero-section h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .hero-section p {
      font-size: 1.05rem;
      opacity: 0.95;
    }

    .hero-section .btn-light {
      background: #fff;
      border: none;
      padding: 0.6rem 1.25rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .hero-section .btn-outline-light {
      color: rgba(255,255,255,0.95);
      border-color: rgba(255,255,255,0.25);
    }

    /* subtle fade-in for hero components */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeInUp 560ms ease both; }

    /* Search Bar */
    .search-container {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      margin-top: 2rem;
      max-width: 600px;
    }

    .search-container input {
      border: none;
      outline: none;
      flex: 1;
      font-size: 1rem;
    }

    .search-container i {
      color: var(--text-secondary);
      margin-right: 1rem;
    }

    /* Post Cards */
    .post-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid var(--border);
      height: 100%;
      cursor: pointer;
    }

    .post-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(217, 119, 6, 0.12);
      border-color: rgba(217, 119, 6, 0.3);
    }

    .card-body {
      padding: 1.5rem;
    }

    /* Posts grid to match sample layout */
    .posts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      align-items: stretch;
    }

    @media (max-width: 992px) {
      .posts-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 576px) {
      .posts-grid { grid-template-columns: 1fr; }
    }

    .post-image {
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: #f3f4f6;
    }

    .post-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .post-category {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(255,255,255,0.95);
      color: var(--primary);
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.75rem;
      box-shadow: 0 2px 8px rgba(217, 119, 6, 0.15);
      border: 1px solid rgba(217, 119, 6, 0.1);
    }

    .card-footer .author-area {
      display:flex;
      align-items:center;
      gap:0.75rem;
    }

    .author-avatar.small {
      width:36px; height:36px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; font-weight:600;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }

    .post-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .post-meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .card-text {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .tag {
      background: rgba(217, 119, 6, 0.08);
      color: #b45309;
      padding: 0.3rem 0.85rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
      border: 1px solid rgba(217, 119, 6, 0.12);
      transition: all 0.2s ease;
      letter-spacing: -0.01em;
    }

    .tag:hover {
      background: rgba(217, 119, 6, 0.12);
      transform: translateY(-1px);
    }

    .card-footer {
      background: var(--light-bg);
      border-top: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* Editor */
    #editor {
      min-height: 400px;
      border: 2px solid var(--border);
      padding: 1.5rem;
      border-radius: 12px;
      background: white;
      font-size: 1rem;
      line-height: 1.8;
      transition: border-color 0.2s ease;
    }

    #editor:focus {
      outline: none;
      border-color: rgba(217, 119, 6, 0.4);
    }

    .editor-toolbar {
      background: var(--light-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .editor-btn {
      background: white;
      border: 1px solid var(--border);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .editor-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Single Post View */
    .post-header {
      margin-bottom: 2rem;
    }

    .post-title {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .author-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .author-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.25rem;
      box-shadow: 0 2px 8px rgba(217, 119, 6, 0.2);
    }

    .author-details {
      flex: 1;
    }

    .author-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .post-date {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    #postContent {
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text-primary);
      margin-bottom: 3rem;
    }

    #postContent img {
      max-width: 100%;
      border-radius: 8px;
      margin: 1.5rem 0;
    }

    /* Engagement Buttons */
    .engagement-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 3rem;
      padding: 1.5rem;
      background: var(--light-bg);
      border-radius: 12px;
    }

    .engagement-btn {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid var(--border);
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .engagement-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      background: rgba(217, 119, 6, 0.03);
      box-shadow: 0 4px 12px rgba(217, 119, 6, 0.08);
    }

    /* Comments */
    .comments-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      border: 1px solid var(--border);
    }

    .comment-item {
      padding: 1.5rem;
      background: var(--light-bg);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .comment-author {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .comment-text {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .comment-input {
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      width: 100%;
      font-size: 1rem;
      transition: border-color 0.2s ease;
      resize: vertical;
      min-height: 100px;
    }

    .comment-input:focus {
      outline: none;
      border-color: rgba(217, 119, 6, 0.5);
      box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.08);
    }

    /* Pagination */
    .pagination {
      gap: 0.5rem;
    }

    .page-item .page-link {
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .page-item.active .page-link {
      background: var(--primary);
      border-color: var(--primary);
    }

    .page-item .page-link:hover {
      background: var(--light-bg);
    }

    /* Auth Forms */
    .auth-container {
      max-width: 450px;
      margin: 4rem auto;
      padding: 2rem;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border);
    }

    .auth-container h3 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .form-control {
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .form-control:focus {
      border-color: rgba(217, 119, 6, 0.5);
      box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.08);
      outline: none;
    }

    /* Loading State */
    .loading-spinner {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-section h1 {
        font-size: 2rem;
      }

      .post-title {
        font-size: 1.75rem;
      }

      .engagement-section {
        flex-direction: column;
      }
    }

    /* Utilities */
    .section-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 2rem;
      color: var(--text-primary);
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 3rem 0;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 4rem;
      color: var(--border);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#/">
        <i class="bi bi-pen-fill"></i> Bloggin
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#/editor">Write</a></li>
        </ul>
        <div class="d-flex align-items-center">
          <div id="auth-area"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- APP CONTAINER -->
  <main id="app" style="margin-top: 76px;">
    <!-- Views are rendered here -->
  </main>

  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <!-- Quill Editor JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
  const API_BASE = 'http://localhost:4000/api';
  // origin for static files (uploads). e.g., http://localhost:4000
  const API_ORIGIN = API_BASE.replace(/\/api\/?$/, '');

  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

  function apiFetch(path, opts={}){
    const token = localStorage.getItem('accessToken');
    const headers = opts.headers || {};
    headers['Content-Type'] = headers['Content-Type'] || 'application/json';
    if(token) headers['Authorization'] = 'Bearer ' + token;
    return fetch(API_BASE + path, { ...opts, headers }).then(async r=>{
      let body;
      try{ body = await r.json(); } catch(e){ body = null; }
      if(!r.ok) throw { status: r.status, body };
      return body;
    });
  }

  function router(){
    const hash = location.hash || '#/';
    if(hash.startsWith('#/editor')) renderEditorView();
    else if(hash.startsWith('#/post/')) {
      const id = hash.split('/')[2];
      renderPostView(id);
    } else if(hash.startsWith('#/login')) renderLoginView();
    else renderHomeView();
    renderAuthArea();
  }

  window.addEventListener('hashchange', router);
  window.addEventListener('load', router);

  function renderAuthArea(){
    const el = qs('#auth-area');
    const user = JSON.parse(localStorage.getItem('me') || 'null');
    if(user){
      el.innerHTML = `
        <div class="d-flex align-items-center gap-3">
          <div class="text-end d-none d-md-block">
            <small class="text-muted">Welcome back,</small><br>
            <strong>${escapeHtml(user.displayName||user.username)}</strong>
          </div>
          <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      `;
      qs('#logoutBtn').onclick = ()=>{
        localStorage.removeItem('accessToken');
        localStorage.removeItem('me');
        location.hash = '#/';
      };
    } else {
      el.innerHTML = `<a class="btn btn-primary" href="#/login"><i class="bi bi-person-circle"></i> Sign In</a>`;
    }
  }

  async function renderHomeView(){
    const container = qs('#app');
    container.innerHTML = `
      <div class="hero-section">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-lg-7">
              <h1 style="font-size:2.75rem;line-height:1.05;">Discover Stories & Ideas</h1>
              <p style="font-size:1.125rem;opacity:0.95;max-width:720px;">Explore thought-provoking articles from writers worldwide — curated insights, interviews, and practical guides to inspire your next post.</p>
              <div class="d-flex gap-3 mt-4 align-items-start" style="position: relative;">
                <a href="#/editor" class="btn btn-light fade-in-up" style="color:var(--primary);font-weight:600;">Write a story</a>
                <div style="position: relative;">
                  <button id="browseTopicsBtn" class="btn btn-outline-light fade-in-up" style="border-color:rgba(255,255,255,0.3);">
                    Browse topics <i class="bi bi-chevron-down" style="font-size: 0.85rem;"></i>
                  </button>
                  <div id="topicsList" style="display:none; position:absolute; z-index:1050; top:100%; left:0; margin-top:8px; background:white; padding:16px; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width:320px; max-width:400px; max-height:320px; overflow-y:auto; border: 1px solid rgba(0,0,0,0.08);">
                    <!-- tags will be injected here -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-5 d-none d-lg-block">
              <!-- Decorative feature panel -->
              <div style="background:rgba(255,255,255,0.06);border-radius:12px;padding:1.25rem;border:1px solid rgba(255,255,255,0.04);">
                <h6 style="color:#fff;opacity:0.9;margin-bottom:0.75rem;">Trending this week</h6>
                <div id="trendingTags" style="display:flex;flex-direction:column;gap:8px;color:rgba(255,255,255,0.95);"></div>
              </div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-8">
              <div class="search-container shadow-sm">
                <i class="bi bi-search"></i>
                <input id="searchInput" type="text" placeholder="Search articles, topics, or authors..." />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container">
        <div id="postsList" class="posts-grid mb-5"></div>
        <div class="d-flex justify-content-center mb-5">
          <nav><ul id="pagination" class="pagination"></ul></nav>
        </div>
      </div>
    `;

    let page = 1, limit = 9;
    const load = async ()=>{
      const list = qs('#postsList');
      list.innerHTML = '<div class="col-12 text-center py-5"><div class="loading-spinner"></div></div>';
      
      const q = qs('#searchInput').value.trim();
      const path = `/posts?page=${page}&limit=${limit}` + (q? `&q=${encodeURIComponent(q)}` : '');
      try{
        const data = await apiFetch(path);
        const posts = data.items || [];
        
        if(posts.length === 0) {
          list.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h4>No posts found</h4>
                <p>Try adjusting your search or check back later</p>
              </div>
            </div>
          `;
          return;
        }
        
        list.innerHTML = posts.map(p=>postCardHtml(p)).join('');
        qsa('.post-card').forEach(el=> el.addEventListener('click', ()=>{
          const id = el.dataset.id; location.hash = '#/post/' + id;
        }));
        renderPagination(data.page, data.totalPages);
      }catch(err){
        console.error(err);
        list.innerHTML = `<div class="col-12"><div class="alert alert-danger">Failed to load posts</div></div>`;
      }
    };

    let searchTimeout;
    qs('#searchInput').addEventListener('input', ()=>{ 
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(()=> { page = 1; load(); }, 500);
    });
    load();

    // fetch tags for trending/topics and wire interactions
    (async function loadTags(){
      try{
        const tags = await apiFetch('/posts/tags/all');
        const trendingEl = qs('#trendingTags');
        const topicsEl = qs('#topicsList');
        if(tags && tags.length){
          trendingEl.innerHTML = tags.slice(0,6).map(t=>`<a href="#" class="text-white" data-tag="${escapeHtml(t)}" style="text-decoration:none">• ${escapeHtml(t)}</a>`).join('');
          topicsEl.innerHTML = tags.map(t=>`<button class="btn btn-sm m-1" data-tag="${escapeHtml(t)}" style="background: rgba(217, 119, 6, 0.08); color: #b45309; border: 1px solid rgba(217, 119, 6, 0.15); border-radius: 999px; padding: 0.4rem 1rem; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;">${escapeHtml(t)}</button>`).join('');
          // wire clicks
          qsa('#trendingTags a').forEach(a=> a.addEventListener('click', (e)=>{ e.preventDefault(); const tag=a.dataset.tag; qs('#searchInput').value = tag; page=1; load(); }));
          qsa('#topicsList button').forEach(b=> {
            b.addEventListener('click', ()=>{ 
              const tag=b.dataset.tag; 
              qs('#searchInput').value = tag; 
              page=1; 
              load(); 
              qs('#topicsList').style.display='none'; 
            });
            b.addEventListener('mouseenter', (e)=>{ 
              e.target.style.background = 'rgba(217, 119, 6, 0.15)'; 
              e.target.style.transform = 'translateY(-1px)'; 
            });
            b.addEventListener('mouseleave', (e)=>{ 
              e.target.style.background = 'rgba(217, 119, 6, 0.08)'; 
              e.target.style.transform = 'translateY(0)'; 
            });
          });
        }
      }catch(e){ console.warn('Failed loading tags', e); }
      // browse button toggle
      const browseBtn = qs('#browseTopicsBtn');
      if(browseBtn) {
        browseBtn.onclick = (ev)=>{
          ev.stopPropagation();
          const topicsEl = qs('#topicsList');
          if(!topicsEl) return;
          topicsEl.style.display = topicsEl.style.display === 'block' ? 'none' : 'block';
        };
      }
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const topicsEl = qs('#topicsList');
        const browseBtn = qs('#browseTopicsBtn');
        if(topicsEl && browseBtn && !topicsEl.contains(e.target) && !browseBtn.contains(e.target)) {
          topicsEl.style.display = 'none';
        }
      });
    })();
  }

  function postCardHtml(p){
    const excerpt = (p.content || '').replace(/<[^>]+>/g,'').slice(0,180);
    const category = (p.tags && p.tags[0]) || 'Article';
    const authorName = p.author?.displayName || p.author?.username || 'Anonymous';
    const initial = authorName.charAt(0).toUpperCase();

    return `
      <div class="post-card" data-id="${escapeHtml(p._id)}">
        <div style="position:relative;">
          <div class="post-image">
            <img src="${(() => {
              const fallback = 'https://picsum.photos/800/500?random=' + encodeURIComponent(p._id || Math.random());
              if (!p.image) return fallback;
              try {
                if (/^https?:\/\//.test(p.image)) return p.image;
                if (p.image.startsWith('/')) return API_ORIGIN + p.image;
                return API_ORIGIN + '/uploads/' + encodeURIComponent(p.image);
              } catch(e) { return fallback; }
            })()}" alt="${escapeHtml(p.title)}" onerror="this.onerror=null;this.src='https://picsum.photos/800/500?random=${escapeHtml(p._id||Math.random())}'" />
          </div>
          <div class="post-category">${escapeHtml(category)}</div>
        </div>
        <div class="card-body">
          <h5 class="card-title">${escapeHtml(p.title)}</h5>
          <p class="card-text">${escapeHtml(excerpt)}${(excerpt.length>=180? '...':'')}</p>
        </div>
        <div class="card-footer">
          <div class="author-area">
            <div class="author-avatar small">${escapeHtml(initial)}</div>
            <div>
              <div style="font-weight:600">${escapeHtml(authorName)}</div>
              <div style="font-size:0.85rem;color:var(--text-secondary)">${formatDate(p.publishedAt||p.createdAt)}</div>
            </div>
          </div>
          <div style="display:flex;gap:0.75rem;align-items:center">
            <div class="stat-item"><i class="bi bi-heart-fill" style="color:#ef4444"></i> <span>${p.likes?.length||0}</span></div>
            <div class="stat-item"><i class="bi bi-chat-dots-fill"></i> <span>${p.commentsCount||0}</span></div>
          </div>
        </div>
      </div>
    `;
  }

  function renderPagination(page, total){
    const el = qs('#pagination');
    if(!total) { el.innerHTML = ''; return; }
    const pages = [];
    for(let i=1;i<=total;i++) pages.push(i);
    el.innerHTML = pages.map(p=>`<li class="page-item ${p===page? 'active':''}"><a class="page-link" href="#" data-page="${p}">${p}</a></li>`).join('');
    qsa('#pagination a').forEach(a=> a.addEventListener('click', e=>{ 
      e.preventDefault(); 
      window.scrollTo(0,0);
      setTimeout(()=> location.reload(), 10);
    }));
  }

  function renderEditorView(){
    const container = qs('#app');
    container.innerHTML = `
      <div class="container py-5">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <h2 class="section-title">Create New Post</h2>
            <div class="mb-4">
              <input id="postTitle" class="form-control form-control-lg" placeholder="Post title" />
            </div>
            <div class="editor-toolbar">
              <button class="editor-btn" title="Bold" onclick="document.execCommand('bold')"><i class="bi bi-type-bold"></i></button>
              <button class="editor-btn" title="Italic" onclick="document.execCommand('italic')"><i class="bi bi-type-italic"></i></button>
              <button class="editor-btn" title="Heading" onclick="document.execCommand('formatBlock', false, 'h2')"><i class="bi bi-type-h2"></i></button>
              <button class="editor-btn" title="List" onclick="document.execCommand('insertUnorderedList')"><i class="bi bi-list-ul"></i></button>
            </div>
            <div id="editor" contenteditable="true" class="mb-4" placeholder="Tell your story..."></div>
            <div class="row g-3 mb-4">
              <div class="col-md-8">
                <input id="tagsInput" class="form-control" placeholder="Add tags (comma separated)" />
              </div>
              <div class="col-md-4">
                <input id="imageInput" type="file" accept="image/*" class="form-control" />
              </div>
            </div>
            <div class="d-flex gap-3 mb-4">
              <button id="saveDraftBtn" class="btn btn-outline-primary flex-fill">
                <i class="bi bi-save"></i> Save Draft
              </button>
              <button id="publishBtn" class="btn btn-primary flex-fill">
                <i class="bi bi-send"></i> Publish
              </button>
            </div>
            <div id="previewArea" style="display:none" class="border rounded-3 p-4"></div>
          </div>
        </div>
      </div>
    `;

    const title = qs('#postTitle');
    const tagsInput = qs('#tagsInput');

    // Ensure we only ever initialize Quill once to avoid duplicate toolbars
    if (window.currentQuill) {
      try {
        // try to disable previous instance if possible
        window.currentQuill.disable();
      } catch (e) {}
      window.currentQuill = null;
    }

    // Initialize Quill editor in the #editor container
    const quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Tell your story...',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });
    // store global reference so subsequent renders reuse/clean it
    window.currentQuill = quill;

    // Handle image uploads: when a file is selected, upload and insert into Quill
    qs('#imageInput').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const data = new FormData(); data.append('file', f);
      try{
    const res = await fetch(API_BASE + '/uploads', { method:'POST', body: data });
    if(!res.ok) throw new Error('upload failed');
    const j = await res.json();
    // ensure absolute URL (server returns '/uploads/filename')
    const imgUrl = (/^https?:\/\//.test(j.url)) ? j.url : (API_ORIGIN + j.url);
    // insert image at current cursor position using the global instance
    const q = window.currentQuill || quill;
    const range = q.getSelection(true) || { index: 0 };
    q.insertEmbed(range.index, 'image', imgUrl);
      }catch(err){ alert('Image upload failed'); console.error(err); }
    });

    async function submit(publish=false){
      const editorInst = window.currentQuill || quill;
      const payload = {
        title: title.value,
        content: editorInst.root.innerHTML,
        tags: tagsInput.value.split(',').map(t=>t.trim()).filter(Boolean),
        published: publish
      };
      try{
        const data = await apiFetch('/posts', { method: 'POST', body: JSON.stringify(payload) });
        location.hash = '#/post/' + data._id;
      }catch(err){ console.error(err); alert('Failed to save post'); }
    }

    qs('#saveDraftBtn').onclick = ()=> submit(false);
    qs('#publishBtn').onclick = ()=> submit(true);
  }

  function insertHtmlAtCursor(html) {
    let sel, range;
    if (window.getSelection) {
      sel = window.getSelection();
      if (sel.getRangeAt && sel.rangeCount) {
        range = sel.getRangeAt(0);
        range.deleteContents();
        const el = document.createElement('div'); el.innerHTML = html;
        const frag = document.createDocumentFragment();
        let node, lastNode;
        while ((node = el.firstChild)) {
          lastNode = frag.appendChild(node);
        }
        range.insertNode(frag);
        if (lastNode) {
          range = range.cloneRange();
          range.setStartAfter(lastNode);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }
  }

  async function renderPostView(slug){
    const container = qs('#app');
    container.innerHTML = `
      <div class="container py-5">
        <div class="text-center py-5"><div class="loading-spinner"></div></div>
      </div>
    `;
    
    try{
      const resp = await apiFetch('/posts/' + encodeURIComponent(slug));
      const post = resp.post || resp;
      const comments = resp.comments || [];
      const safeHtml = DOMPurify.sanitize(post.content || '');
      const authorName = post.author?.displayName || post.author?.username || 'Anonymous';
      const initial = authorName.charAt(0).toUpperCase();
      
      container.innerHTML = `
        <div class="container py-4">
          <div class="row">
            <div class="col-lg-8 mx-auto">
              <article>
                <div class="post-header">
                  <h1 class="post-title">${escapeHtml(post.title)}</h1>
                  <div class="author-info">
                    <div class="author-avatar">${initial}</div>
                    <div class="author-details">
                      <div class="author-name">${escapeHtml(authorName)}</div>
                      <div class="post-date">
                        <i class="bi bi-calendar3"></i> ${formatDate(post.publishedAt||post.createdAt)}
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">${(post.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ')}</div>
                </div>
                <div id="postContent" class="mb-4">${safeHtml}</div>
                
                <div class="engagement-section">
                  <button id="likeBtn" class="engagement-btn">
                    <i class="bi bi-heart-fill"></i>
                    <span>Like (<span id="likesCount">${post.likes?.length||0}</span>)</span>
                  </button>
                  <button id="dislikeBtn" class="engagement-btn">
                    <i class="bi bi-hand-thumbs-down"></i>
                    <span>Dislike (<span id="dislikesCount">${post.dislikes?.length||0}</span>)</span>
                  </button>
                </div>

                <div class="divider"></div>

                <section class="comments-section">
                  <h4 class="mb-4"><i class="bi bi-chat-dots"></i> Comments (${comments.length})</h4>
                  <div id="commentsList" class="mb-4"></div>
                  <div class="mt-4">
                    <h5 class="mb-3">Leave a comment</h5>
                    <textarea id="commentInput" class="comment-input" placeholder="Share your thoughts..."></textarea>
                    <div class="mt-3 text-end">
                      <button id="commentBtn" class="btn btn-primary">
                        <i class="bi bi-send"></i> Post Comment
                      </button>
                    </div>
                  </div>
                </section>
              </article>
            </div>
          </div>
        </div>
      `;

      qs('#likeBtn').onclick = async ()=>{
        try{
          const res = await apiFetch(`/posts/${post._id}/like`, { method: 'POST' });
          qs('#likesCount').textContent = res.likes?.length ?? res.likes ?? 0;
          qs('#dislikesCount').textContent = res.dislikes?.length ?? res.dislikes ?? 0;
        }catch(err){ handleApiErr(err); }
      };
      
      qs('#dislikeBtn').onclick = async ()=>{
        try{
          const res = await apiFetch(`/posts/${post._id}/dislike`, { method: 'POST' });
          qs('#likesCount').textContent = res.likes?.length ?? res.likes ?? 0;
          qs('#dislikesCount').textContent = res.dislikes?.length ?? res.dislikes ?? 0;
        }catch(err){ handleApiErr(err); }
      };

      qs('#commentBtn').onclick = async ()=>{
        const txt = qs('#commentInput').value.trim(); if(!txt) return;
        try{
          await apiFetch('/comments', { method: 'POST', body: JSON.stringify({ post: post._id, content: txt }) });
          qs('#commentInput').value = '';
          await loadComments(post._id);
        }catch(err){ handleApiErr(err); }
      };

      renderComments(comments);
    }catch(err){
      console.error(err);
      container.innerHTML = `
        <div class="container py-5">
          <div class="alert alert-danger">Failed to load post</div>
        </div>
      `;
    }
  }

  function renderComments(comments){
    const list = qs('#commentsList');
    if(!comments || comments.length === 0) {
      list.innerHTML = `
        <div class="empty-state py-4">
          <i class="bi bi-chat"></i>
          <p>No comments yet. Be the first to share your thoughts!</p>
        </div>
      `;
      return;
    }
    
    list.innerHTML = comments.map(c=>{
      const authorName = c.author?.displayName || c.author?.username || 'Anonymous';
      const initial = authorName.charAt(0).toUpperCase();
      return `
        <div class="comment-item">
          <div class="d-flex gap-3 mb-2">
            <div class="author-avatar" style="width: 40px; height: 40px; font-size: 1rem;">${initial}</div>
            <div class="flex-grow-1">
              <div class="comment-author">${escapeHtml(authorName)}</div>
              <div class="small text-muted mb-2">
                <i class="bi bi-clock"></i> ${formatDate(c.createdAt)}
              </div>
              <div class="comment-text">${escapeHtml(c.content)}</div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  async function loadComments(postId){
    try{
      const data = await apiFetch(`/comments?post=${postId}`);
      renderComments(data.items || []);
    }catch(err){ console.error(err); }
  }

  function renderLoginView(){
    const container = qs('#app');
    container.innerHTML = `
      <div class="container">
        <div class="auth-container">
          <h3><i class="bi bi-person-circle"></i> Welcome Back</h3>
          <p class="text-center text-muted mb-4">Sign in to continue</p>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="email" type="email" class="form-control" placeholder="your@email.com" />
          </div>
          <div class="mb-4">
            <label class="form-label">Password</label>
            <input id="password" type="password" class="form-control" placeholder="••••••••" />
          </div>
          <div class="d-grid gap-2">
            <button id="loginBtn" class="btn btn-primary btn-lg">
              <i class="bi bi-box-arrow-in-right"></i> Sign In
            </button>
            <button id="showRegister" class="btn btn-outline-secondary">
              Don't have an account? Register
            </button>
          </div>
        </div>
      </div>
    `;
    
    qs('#showRegister').onclick = ()=> renderRegisterView();
    qs('#loginBtn').onclick = async ()=>{
      const prev = qs('#loginError'); if(prev) prev.remove();
      const btn = qs('#loginBtn');
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width: 1rem; height: 1rem; border-width: 2px;"></span> Signing in...';
      
      try{
        const res = await fetch(API_BASE + '/users/login', {
          method: 'POST', 
          headers: {'Content-Type':'application/json'}, 
          body: JSON.stringify({ 
            email: qs('#email').value, 
            password: qs('#password').value 
          })
        });
        let j = null;
        try{ j = await res.json(); } catch(e){}
        
        if(!res.ok){
          const msg = j?.message || j?.error || 'Login failed';
          const alertEl = document.createElement('div'); 
          alertEl.id = 'loginError'; 
          alertEl.className = 'alert alert-danger'; 
          alertEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${msg}`;
          qs('.auth-container').prepend(alertEl);
          btn.disabled = false;
          btn.innerHTML = originalHtml;
          return;
        }
        
        if(!j || !j.accessToken){
          throw new Error('Invalid response from server');
        }
        
        localStorage.setItem('accessToken', j.accessToken);
        localStorage.setItem('me', JSON.stringify(j.user));
        location.hash = '#/';
      }catch(err){ 
        console.error(err); 
        const alertEl = document.createElement('div'); 
        alertEl.id='loginError'; 
        alertEl.className='alert alert-danger'; 
        alertEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${err.message||'Request failed'}`;
        qs('.auth-container').prepend(alertEl);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    };
  }

  function renderRegisterView(){
    const container = qs('#app');
    container.innerHTML = `
      <div class="container">
        <div class="auth-container">
          <h3><i class="bi bi-person-plus"></i> Create Account</h3>
          <p class="text-center text-muted mb-4">Join our community</p>
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input id="usernameR" class="form-control" placeholder="Choose a username" />
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="emailR" type="email" class="form-control" placeholder="your@email.com" />
          </div>
          <div class="mb-4">
            <label class="form-label">Password</label>
            <input id="passwordR" type="password" class="form-control" placeholder="Create a strong password" />
          </div>
          <div class="d-grid gap-2">
            <button id="registerBtn" class="btn btn-primary btn-lg">
              <i class="bi bi-check-circle"></i> Create Account
            </button>
            <button id="backLogin" class="btn btn-outline-secondary">
              Already have an account? Sign in
            </button>
          </div>
        </div>
      </div>
    `;
    
    qs('#backLogin').onclick = () => renderLoginView();
    qs('#registerBtn').onclick = async ()=>{
      const prev = qs('#registerError'); if(prev) prev.remove();
      const btn = qs('#registerBtn');
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width: 1rem; height: 1rem; border-width: 2px;"></span> Creating account...';
      
      try{
        const res = await fetch(API_BASE + '/users/register', { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({ 
            username: qs('#usernameR').value, 
            email: qs('#emailR').value, 
            password: qs('#passwordR').value 
          }) 
        });
        let j = null; 
        try{ j = await res.json(); } catch(e){}
        
        if(!res.ok){ 
          const msg = j?.message || j?.error || 'Registration failed'; 
          const alertEl = document.createElement('div'); 
          alertEl.id='registerError'; 
          alertEl.className='alert alert-danger'; 
          alertEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${msg}`;
          qs('.auth-container').prepend(alertEl); 
          btn.disabled = false;
          btn.innerHTML = originalHtml;
          return; 
        }
        
        if(j && j.accessToken){ 
          localStorage.setItem('accessToken', j.accessToken); 
          localStorage.setItem('me', JSON.stringify(j.user)); 
          location.hash = '#/'; 
          return; 
        }
        
        alert('Account created successfully! Please sign in.');
        location.hash = '#/login';
      }catch(err){ 
        console.error(err); 
        const alertEl = document.createElement('div'); 
        alertEl.id='registerError'; 
        alertEl.className='alert alert-danger'; 
        alertEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${err.message||'Request failed'}`;
        qs('.auth-container').prepend(alertEl);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    };
  }

  function escapeHtml(s){ 
    if(s==null) return ''; 
    return String(s).replace(/[&<>"]+/g, function(c){ 
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; 
    }); 
  }

  function formatDate(dateStr){
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if(days === 0) return 'Today';
    if(days === 1) return 'Yesterday';
    if(days < 7) return `${days} days ago`;
    if(days < 30) return `${Math.floor(days/7)} weeks ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function handleApiErr(err){
    console.error(err);
    if(err && err.status===401){ 
      alert('Please sign in to continue'); 
      location.hash = '#/login'; 
    } else {
      alert('Request failed. Please try again.');
    }
  }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>